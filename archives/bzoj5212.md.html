<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ZJOI2018 历史</title>
  <link rel="stylesheet" type="text/css" id="frame_style" href="../css/frame_style1.css">
  <link rel="stylesheet" type="text/css" id="Markdown_style" href="../css/Markdown_style.css">
  <script type="text/javascript" src="../jscode/frame.js"></script>
  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
  <link rel="stylesheet" href="https://ziyuan.fenxianglu.cn/js/highlight/styles/default.css">
  <script src="https://ziyuan.fenxianglu.cn/js/highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
        inlineMath: [['$','$']]
      }
    });
  </script>
</head>
<body>
  <div class="main">
    <div class="head">
      <div class="title1">
        <a href="../index.html">wjh15101051's space</a>
      </div>
      <div class="title2">
        卧薪尝胆，厚积薄发。
      </div>
    </div>
    <div id="middle_blogfile">
      <div class="blog_blogfile">
        <div class="blogfile_title">
            ZJOI2018 历史
        </div>
        <div class="blogfile_stitle">
          <img src="http://pic.yupoo.com/wjh15101051/1e0e1b3a/118165c5.jpg">
          Date: Fri Nov 23 11:41:11 CST 2018
          <img src="http://pic.yupoo.com/wjh15101051/2ea96b56/7882c4ab.png">
          In Category:
          <a href="../categories/NoCategory.html">NoCategory</a>
        </div>
        <div class="blogfile_content">
<div class = "MarkdownCommonContent">
</div>
<div class = "MarkdownCommonContent">
<h2 class = "MarkdownH2">
Description：
</h2>
</div>
<div class = "MarkdownCommonContent">
给一棵树和树上每个点
$access$
操作的次数
$a[i]$
，求出轻重链切换次数的最大值，支持给
$a[i]$
增加一个正整数。
</div>
<div class = "MarkdownCommonContent">
$1\leqslant n\leqslant4\times 10^5$
</div>
<div class = "MarkdownCommonContent">
<h2 class = "MarkdownH2">
Solution：
</h2>
</div>
<div class = "MarkdownCommonContent">
首先我们可以把这些轻重链切换按他们所在的点分类，对于点
$k$
，如果它的子树（包括它）
$a[i]$
之和为
$S$
，最大值为
$mx$
，注意由于只考虑在这个点的切换所以来自同一个子树的
$a[i]$
都是等价的，也就是说这个最大值实际是子树的
$S$
的最大值而不是单点的最大值，那么在这个点会产生的贡献最大是：
$res[k]=\min(S-1,2\times(S-mx))$
，也就是说如果不存在一个
$mx&gt;\lfloor\frac S 2\rfloor$
那么就可以把他们两两都不相邻，否则剩下的每个可以和它左边和右边产生贡献，这样就可以
$O(n)$
求出整棵树的贡献，但是还要支持动态修改，但是并不用动态
$DP$
，好像也不能用，仔细研究一下会发现如果某个子树
$i$
满足
$S_i&gt;\lfloor\frac{S_k}2\rfloor$
那么子树
$i$
内的单点增量是不影响
$k$
的
$res$
的，因为反正也是做差，那么我们可以借用
$LCT$
的思想，把这样的一条链用一棵
$splay$
来维护，不符合这样的用虚父亲也就是轻边来维护，那么我们就可以跳过大段的重边，也就是说一次单点增量只有轻边的父亲的
$res$
会改变，还有一个更优秀的性质是按照这样类似轻重链剖分的做法也是满足树链剖分从某个点到根轻边个数不超过
$\log$
个这个性质的，因为轻边是一定满足
$S_i\leqslant\lfloor\frac{S_k}2\rfloor$
，那么我们就可以先一次
$dfs$
求出初始答案，然后每次考虑答案的增量，也就是像
$access$
那样不断往上跳，同时维护轻重链切换的关系以及答案的变化，由糖水不等式
$\frac{a+c}{b+c}&gt;\frac a b$
得这条链上是重儿子的还一定是重儿子，但可能别的链在虚边那里切换成了轻儿子，同时顺便用
$splay$
来维护当前每个点的
$S_k$
，这个只要子树加打标记即可，实现的时候和
$LCT$
略有不同因为不能简单跳虚边，轻重边切换时一定要用它在原树上的儿子而不能用辅助树上的儿子。
</div>
<div class = "MarkdownCommonContent">
<h2 class = "MarkdownH2">
Code：
</h2>
</div>
<div class = "MarkdownCommonContent">
<pre><code class="MarkdownParaCode">
#include&lt;algorithm&gt;<br />
#include&lt;iostream&gt;<br />
#include&lt;cstdlib&gt;<br />
#include&lt;cstdio&gt;<br />
#include&lt;cmath&gt;<br />
#include&lt;stack&gt;<br />
#include&lt;cctype&gt;<br />
#include&lt;cstring&gt;<br />
using namespace std;<br />
inline int rd()<br />
{<br />
	register int res = 0,f = 1;<br />
	register char c = getchar();<br />
	while(!isdigit(c))<br />
	{<br />
		if(c == '-')f = -1;<br />
		c = getchar();<br />
	}<br />
	while(isdigit(c))<br />
	{<br />
		res = (res &lt;&lt; 1) + (res &lt;&lt; 3) + c - '0';<br />
		c = getchar();<br />
	}<br />
	return res * f;<br />
}<br />
int n,m;<br />
#define MAXN 400010<br />
long long a[MAXN];<br />
struct edge<br />
{<br />
	int to,nxt;<br />
}e[MAXN &lt;&lt; 1];<br />
int edgenum = 0;<br />
int lin[MAXN] = {0};<br />
void add(int a,int b)<br />
{<br />
	e[++edgenum] = (edge){b,lin[a]};lin[a] = edgenum;<br />
	e[++edgenum] = (edge){a,lin[b]};lin[b] = edgenum;<br />
	return;<br />
}<br />
typedef long long ll;<br />
struct node<br />
{<br />
	int c[2],fa;<br />
	ll val,tag;<br />
}t[MAXN];<br />
bool isroot(int k){return (t[t[k].fa].c[0] != k && t[t[k].fa].c[1] != k);}<br />
int id(int k){return (t[t[k].fa].c[0] == k ? 0 : 1);}<br />
void connect(int k,int f,int p){t[k].fa = f;t[f].c[p] = k;return;}<br />
void pushdown(int rt)<br />
{<br />
	if(t[rt].tag != 0)<br />
	{<br />
		if(t[rt].c[0] != 0){t[t[rt].c[0]].tag += t[rt].tag;t[t[rt].c[0]].val += t[rt].tag;}<br />
		if(t[rt].c[1] != 0){t[t[rt].c[1]].tag += t[rt].tag;t[t[rt].c[1]].val += t[rt].tag;}<br />
		t[rt].tag = 0;<br />
	}<br />
	return;<br />
}<br />
void rotate(int x)<br />
{<br />
	int y = t[x].fa,z = t[y].fa,fx = id(x),fy = id(y);<br />
	if(!isroot(y))t[z].c[fy] = x;<br />
	t[x].fa = z;<br />
	connect(t[x].c[fx ^ 1],y,fx);<br />
	connect(y,x,fx ^ 1);<br />
	return;<br />
}<br />
stack&lt;int&gt; s;<br />
void splay(int x)<br />
{<br />
	s.push(x);<br />
	for(int i = x;!isroot(i);i = t[i].fa)s.push(t[i].fa);<br />
	while(!s.empty()){pushdown(s.top());s.pop();}<br />
	while(!isroot(x))<br />
	{<br />
		int y = t[x].fa;<br />
		if(isroot(y)){rotate(x);break;}<br />
		if(id(x) == id(y)){rotate(y);rotate(x);}<br />
		else{rotate(x);rotate(x);}<br />
	}<br />
	return;<br />
}<br />
void set(int rt,ll k)<br />
{<br />
	if(rt == 0)return;<br />
	t[rt].val += k;t[rt].tag += k;<br />
	return;<br />
}<br />
ll ans = 0;<br />
bool vis[MAXN];<br />
ll sum[MAXN];<br />
ll res[MAXN];<br />
void dfs(int k)<br />
{<br />
	vis[k] = true;<br />
	sum[k] = a[k];<br />
	for(int i = lin[k];i != 0;i = e[i].nxt)<br />
	{<br />
		if(vis[e[i].to])continue;<br />
		dfs(e[i].to);<br />
		sum[k] += sum[e[i].to];<br />
	}<br />
	t[k].val = sum[k];<br />
	bool tag = false;<br />
	for(int i = lin[k];i != 0;i = e[i].nxt)<br />
	{<br />
		if(vis[e[i].to])continue;<br />
		if(sum[e[i].to] &gt; sum[k] / 2)<br />
		{<br />
			splay(k);splay(e[i].to);<br />
			connect(e[i].to,k,1);<br />
			tag = true;<br />
			res[k] = (sum[k] - sum[e[i].to]) * 2;<br />
		}<br />
		else<br />
		{<br />
			t[e[i].to].fa = k;<br />
		}<br />
	}<br />
	if(a[k] &gt; sum[k] / 2)<br />
	{<br />
		tag = true;<br />
		res[k] = (sum[k] - a[k]) * 2;<br />
	}<br />
	if(!tag)res[k] = sum[k] - 1;<br />
	ans += res[k];<br />
	vis[k] = false;<br />
	return;<br />
}<br />
int main()<br />
{<br />
	scanf("%d%d",&n,&m);<br />
	for(int i = 1;i &lt;= n;++i)a[i] = rd();<br />
	for(int i = 1;i &lt; n;++i)add(rd(),rd());<br />
	dfs(1);<br />
	cout &lt;&lt; ans &lt;&lt; endl;<br />
	int x,y;<br />
	for(int i = 1;i &lt;= m;++i)<br />
	{<br />
		x = rd();y = rd();<br />
		for(int i = x;i;i = t[i].fa)<br />
		{<br />
			splay(i);pushdown(i);set(t[i].c[0],y);t[i].val += y;<br />
		}<br />
		a[x] += y;<br />
		while(x)<br />
		{<br />
			splay(x);pushdown(x);<br />
			ans -= res[x];<br />
			int nxt = t[x].c[1];<br />
			while(nxt != 0 && t[nxt].c[0] != 0)<br />
			{<br />
				pushdown(nxt);<br />
				nxt = t[nxt].c[0];<br />
			}<br />
			if(nxt != 0 && t[nxt].val &lt;= t[x].val / 2)nxt = t[x].c[1] = 0;<br />
			if(nxt != 0)res[x] = (t[x].val - t[nxt].val) * 2;<br />
			else if(a[x] &gt; t[x].val / 2)res[x] = (t[x].val - a[x]) * 2;<br />
			else res[x] = t[x].val - 1;<br />
			ans += res[x];<br />
			while(t[x].c[0] != 0)x = t[x].c[0];<br />
			splay(x);<br />
			int f = t[x].fa;<br />
			if(f == 0)break;<br />
			splay(f);<br />
			if(t[x].val &gt; t[f].val / 2)t[f].c[1] = x;<br />
			x = f;<br />
		}<br />
		printf("%lld\n",ans);<br />
	}<br />
	return 0;<br />
}<br />
</pre></code>
</div>
        </div>
        <div class="blogfile_showtag">
          <img src="http://pic.yupoo.com/wjh15101051/2380cc18/89ee2c05.png">
          In tag:
<a href="../tags/数据结构-LCT.html">数据结构-LCT</a> 
          <!--<a href="../tags/blog.html">blog</a>-->
        </div>
      </div>
    </div>
    <div id="middle_nav">
      <div class="blog_host">
        <div class="nav_avator">
          <img src="http://pic.yupoo.com/wjh15101051/72c1aeab/f51d56e0.jpg" alt="avator">
        </div>
        <div class="nav_ID">
          wjh15101051
        </div>
      </div>
      <div class="nav_list">
        <li class="tags">
          <a href="../tags.html">
            <img src="http://pic.yupoo.com/wjh15101051/2380cc18/89ee2c05.png" class="list_icon" id="tags_image">
            Tags
          </a>
        </li>
        <li class="categories">
          <a href="../categories.html">
            <img src="http://pic.yupoo.com/wjh15101051/2ea96b56/7882c4ab.png" class="list_icon" id="categories_image">
            Categories
          </a>
        </li>
        <li class="timeline">
          <a href="../timeline.html">
            <img src="http://pic.yupoo.com/wjh15101051/30365cc7/c1a3be15.png" class="list_icon" id="timeline_image">
            Timeline
          </a>
        </li>
        <li class="about">
          <a href="../about.html">
            <img src="http://pic.yupoo.com/wjh15101051/24f1cb41/e239086e.png" class="list_icon" id="about_image">
            About
          </a>
        </li>
        <li class="toolbox">
          <a href="../toolbox.html">
            <img src="http://pic.yupoo.com/wjh15101051/dee9f673/d3cf682a.png" class="list_icon" id="toolbox_image">
            Toolbox
          </a>
        </li>
        <li class="friends">
            <div class="friends_text">
              <img src="http://pic.yupoo.com/wjh15101051/d291ebed/29f9c807.png" id="friends_image">
              Friends
            </div>
            <div id="fp_friends_list">
              <div id="SGcolin">
                <a href="http://blog.gyx.me/" target="_blank">SGcolin</a>
              </div>
              <div id="Xingcy">
                <a href="https://www.cnblogs.com/xcysblog/" target="_blank">Xingcy</a>
              </div>
              <div id="ZH_comld">
                <a href="https://www.cnblogs.com/ZH-comld/" target="_blank">ZH_comld</a>
              </div>
            </div>
            <br>
          </div>
        </li>
      </div>
    <div class="music_player">
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.0/dist/APlayer.min.css">
      <script src="https://blog-static.cnblogs.com/files/yjlaugus/APlayer.min.js"></script>
      <div id="aplayer" class="aplayer"  data-id="5313691453" data-server="netease" data-type="playlist" data-fixed="true" data-listfolded="true" data-order="random" data-theme="#F58EA8"></div>
      <script src="https://unpkg.com/meting@1.2/dist/Meting.min.js"></script>
    </div>
    <div class="bottom">
      <div>
        Copyright © 2020
        <a id="copyright_user_a" href="index.html">
          <span id="copyright_user">wjh15101051</span>
        </a>
      </div>
      <div class="bottom_anime">ღゝ◡╹)ノ♡</div>
    </div>
  </div>
</body>
</html>
