<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dynamic Rankings</title>
  <link rel="stylesheet" type="text/css" id="frame_style" href="../css/frame_style1.css">
  <link rel="stylesheet" type="text/css" id="Markdown_style" href="../css/Markdown_style.css">
  <script type="text/javascript" src="../jscode/frame.js"></script>
  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
  <link rel="stylesheet" href="https://ziyuan.fenxianglu.cn/js/highlight/styles/default.css">
  <script src="https://ziyuan.fenxianglu.cn/js/highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
        inlineMath: [['$','$']]
      }
    });
  </script>
</head>
<body>
  <div class="main">
    <div class="head">
      <div class="title1">
        <a href="../index.html">wjh15101051's space</a>
      </div>
      <div class="title2">
        卧薪尝胆，厚积薄发。
      </div>
    </div>
    <div id="middle_blogfile">
      <div class="blog_blogfile">
        <div class="blogfile_title">
            Dynamic Rankings
        </div>
        <div class="blogfile_stitle">
          <img src="http://pic.yupoo.com/wjh15101051/1e0e1b3a/118165c5.jpg">
          Date: Sun Sep 09 17:33:38 CST 2018
          <img src="http://pic.yupoo.com/wjh15101051/2ea96b56/7882c4ab.png">
          In Category:
          <a href="../categories/NoCategory.html">NoCategory</a>
        </div>
        <div class="blogfile_content">
<div class = "MarkdownCommonContent">
</div>
<div class = "MarkdownCommonContent">
<h2 class = "MarkdownH2">
Description：
</h2>
</div>
<div class = "MarkdownCommonContent">
带修改区间第
$K$
大。
</div>
<div class = "MarkdownCommonContent">
$1\le n \le 100000$
</div>
<div class = "MarkdownCommonContent">
<h2 class = "MarkdownH2">
Solution：
</h2>
</div>
<div class = "MarkdownCommonContent">
做法一：树状数组套权值线段树，也就是带修改主席树。
</div>
<div class = "MarkdownCommonContent">
<h4 class = "MarkdownH4">
Code：
</h4>
</div>
<div class = "MarkdownCommonContent">
<pre><code class="MarkdownParaCode">
#include&lt;algorithm&gt;<br />
#include&lt;iostream&gt;<br />
#include&lt;cstdlib&gt;<br />
#include&lt;cstdio&gt;<br />
#include&lt;cmath&gt;<br />
#include&lt;cstring&gt;<br />
using namespace std;<br />
int n,m;<br />
int a1[300100],s[300100],a2[300100];<br />
int b[700100];<br />
int in[300100][10];<br />
int totn = 0;<br />
int lowbit(int x)<br />
{<br />
    return x & (-x);<br />
}<br />
bool cmp(int k1,int k2)<br />
{<br />
    return b[k1] &lt; b[k2];<br />
};<br />
struct node<br />
{<br />
    int l,r;<br />
    node *ls,*rs;<br />
    int sum;<br />
    node(){l = r = sum = 0;ls = NULL;rs = NULL;}<br />
}t[1500000];<br />
node *ptr = t;<br />
node *c[300100];<br />
node *newnode(){return ++ptr;}<br />
void build(node *(&root))<br />
{<br />
    root = newnode();<br />
    root -&gt; l = 1;<br />
    root -&gt; r = totn;<br />
    return;<br />
}<br />
int search(int k)<br />
{<br />
    int l = 1,r = totn,mid;<br />
    while(l &lt; r)<br />
    {<br />
        mid = (l + r) &gt;&gt; 1;<br />
        if(b[s[mid]] == k)return mid;<br />
        if(b[s[mid]] &lt; k)<br />
        {<br />
            l = mid + 1;<br />
        }<br />
        else<br />
        {<br />
            r = mid - 1;<br />
        }<br />
    }<br />
}<br />
void get(node *p,int c)<br />
{<br />
    if(c == 1 && p -&gt; ls == NULL)<br />
    {<br />
        p -&gt; ls = newnode();<br />
        p -&gt; ls -&gt; l = p -&gt; l;<br />
        p -&gt; ls -&gt; r = (p -&gt; l + p -&gt; r) &gt;&gt; 1;<br />
        return;<br />
    }<br />
    if(c == 2 && p -&gt; rs == NULL)<br />
    {<br />
        p -&gt; rs = newnode();<br />
        p -&gt; rs -&gt; l = ((p -&gt; l + p -&gt; r) &gt;&gt; 1) + 1;<br />
        p -&gt; rs -&gt; r = p -&gt; r;<br />
        return;<br />
    }<br />
    return;<br />
}<br />
void insert(node *root,int x)<br />
{<br />
    int mid;<br />
    while(root -&gt; l != root -&gt; r)<br />
    {<br />
        root -&gt; sum += 1;<br />
        mid = (root -&gt; l + root -&gt; r) &gt;&gt; 1;<br />
        if(x &lt;= mid)<br />
        {<br />
            get(root,1);<br />
            root = root -&gt; ls;<br />
        }<br />
        else<br />
        {<br />
            get(root,2);<br />
            root = root -&gt; rs;<br />
        }<br />
    }<br />
    root -&gt; sum += 1;<br />
    return;<br />
}<br />
void remove(node *root,int x)<br />
{<br />
    int mid;<br />
    while(root -&gt; l != root -&gt; r)<br />
    {<br />
        root -&gt; sum -= 1;<br />
        mid = (root -&gt; l + root -&gt; r) &gt;&gt; 1;<br />
        if(x &lt;= mid)<br />
        {<br />
            root = root -&gt; ls;<br />
        }<br />
        else<br />
        {<br />
            root = root -&gt; rs;<br />
        }<br />
    }<br />
    root -&gt; sum -= 1;<br />
    return;<br />
}<br />
void add(int p,int x)<br />
{<br />
    int k = search(x);<br />
    for(int i = p;i &lt;= n;i += lowbit(i))<br />
    {<br />
        insert(c[i],k);<br />
    }<br />
    return;<br />
}<br />
void dec(int p,int x)<br />
{<br />
    int k = search(x);<br />
    for(int i = p;i &lt;= n;i += lowbit(i))<br />
    {<br />
        remove(c[i],k);<br />
    }<br />
    return;<br />
}<br />
node *d1[30000],*d2[30000];<br />
int t1,t2;<br />
int query(int l,int r,int k)<br />
{<br />
    t1 = t2 = 0;<br />
    for(int i = l - 1;i &gt;= 1;i -= lowbit(i))d1[++t1] = c[i];<br />
    for(int i = r;i &gt;= 1;i -= lowbit(i))d2[++t2] = c[i];<br />
    int k1 = 0,k2 = 0,x;<br />
    int _l = 1,_r = totn;<br />
    while(_l != _r)<br />
    {<br />
        k1 = k2 = 0;<br />
        for(int i = 1;i &lt;= t1;++i){if(d1[i] -&gt; ls == NULL)continue;k1 += d1[i] -&gt; ls -&gt; sum;}<br />
        for(int i = 1;i &lt;= t2;++i){if(d2[i] -&gt; ls == NULL)continue;k2 += d2[i] -&gt; ls -&gt; sum;}<br />
        x = k2 - k1;<br />
        if(k &gt; x)<br />
        {<br />
            k -= x;<br />
            for(int i = 1;i &lt;= t1;++i){get(d1[i],2);d1[i] = d1[i] -&gt; rs;}<br />
            for(int i = 1;i &lt;= t2;++i){get(d2[i],2);d2[i] = d2[i] -&gt; rs;}<br />
            _l = ((_l + _r) &gt;&gt; 1) + 1;<br />
        }<br />
        else<br />
        {<br />
            for(int i = 1;i &lt;= t1;++i){get(d1[i],1);d1[i] = d1[i] -&gt; ls;}<br />
            for(int i = 1;i &lt;= t2;++i){get(d2[i],1);d2[i] = d2[i] -&gt; ls;}<br />
            _r = (_l + _r) &gt;&gt; 1;<br />
        }<br />
    }<br />
    return b[s[_l]];<br />
}<br />
void change(int p,int x)<br />
{<br />
    dec(p,a1[p]);<br />
    a1[p] = x;<br />
    add(p,x);<br />
    return;<br />
}<br />
int main()<br />
{<br />
    scanf("%d%d",&n,&m);<br />
    for(int i = 1;i &lt;= n;++i)<br />
    {<br />
        scanf("%d",&a1[i]);<br />
        b[++totn] = a1[i];<br />
        s[totn] = totn;<br />
    }<br />
    char k1;<br />
    for(int i = 1;i &lt;= m;++i)<br />
    {<br />
        cin &gt;&gt; k1;<br />
        if(k1 == 'Q')<br />
        {<br />
            in[i][0] = 1;<br />
            scanf("%d%d%d",&in[i][1],&in[i][2],&in[i][3]);<br />
        }<br />
        else<br />
        {<br />
            in[i][0] = 0;<br />
            scanf("%d%d",&in[i][1],&in[i][2]);<br />
            b[++totn] = in[i][2];<br />
            s[totn] = totn;<br />
        }<br />
    }<br />
    sort(s + 1,s + 1 + totn,cmp);<br />
    for(int i = 1;i &lt;= totn;++i)a2[s[i]] = i;<br />
    for(int i = 1;i &lt;= n;++i)build(c[i]);<br />
    for(int i = 1;i &lt;= n;++i)add(i,a1[i]);<br />
    for(int i = 1;i &lt;= m;++i)<br />
    {<br />
        if(in[i][0] == 1)<br />
        {<br />
            printf("%d\n",query(in[i][1],in[i][2],in[i][3]));<br />
        }<br />
        else<br />
        {<br />
            change(in[i][1],in[i][2]);<br />
        }<br />
    }<br />
    return 0;<br />
}<br />
</pre></code>
</div>
<div class = "MarkdownCommonContent">
做法二：整体二分。
</div>
<div class = "MarkdownCommonContent">
首先把最开始的数列变成单点赋值的操作，询问操作不变，单点修改操作变为一个单点清空，一个单点赋值，然后把整个操作序列和值域丢进去整体二分。
</div>
<div class = "MarkdownCommonContent">
依次遍历所有操作，如果是修改操作，那么如果修改后的值小于等于
$mid$
，就在树状数组中把他加进去并丢到左区间，否则什么都不做并丢到右区间，如果是询问操作，那么就在树状数组中查询区间
$[l,r]$
，因为只把小于等于
$mid$
的数插进去，所以查询出来的结果只是这些区间中小于等于
$mid$
的数的个数，如果小于等于
$mid$
，就把它丢到左区间，否则
$-res$
，并丢到右区间，这样每个值域保存的就是在值域内的操作和询问。
</div>
<div class = "MarkdownCommonContent">
简单来说整体二分就是对于一些二分
$check$
复杂度太高，如果每个询问都二分会超时，而很多
$check$
的预处理有很多公共部分，所以把这些询问的
$check$
放到一起。
</div>
<div class = "MarkdownCommonContent">
<h4 class = "MarkdownH4">
Code：
</h4>
</div>
<div class = "MarkdownCommonContent">
<pre><code class="MarkdownParaCode">
#include&lt;algorithm&gt;<br />
#include&lt;iostream&gt;<br />
#include&lt;cstdlib&gt;<br />
#include&lt;cstdio&gt;<br />
#include&lt;cmath&gt;<br />
#include&lt;map&gt;<br />
#include&lt;cctype&gt;<br />
#include&lt;cstring&gt;<br />
using namespace std;<br />
inline int read()<br />
{<br />
	register int res = 0;<br />
	register char c = getchar();<br />
	while(!isdigit(c))c = getchar();<br />
	while(isdigit(c))<br />
	{<br />
		res = (res &lt;&lt; 1) + (res &lt;&lt; 3) + c - '0';<br />
		c = getchar();<br />
	}<br />
	return res;<br />
}<br />
inline char getc()<br />
{<br />
	register char c = getchar();<br />
	while(c != 'Q' && c != 'C')c = getchar();<br />
	return c;<br />
}<br />
int n,m;<br />
#define MAXN 100010<br />
int a[MAXN];<br />
int num[MAXN &lt;&lt; 1],cur = 0;<br />
int to[MAXN &lt;&lt; 1],cnt = 0;<br />
map&lt;int,int&gt; fr;<br />
int ans[MAXN];<br />
struct option<br />
{<br />
	int type,x,y,k,id;<br />
}q[MAXN * 3],q1[MAXN * 3],q2[MAXN * 3];<br />
int tot = 0;<br />
int c[MAXN &lt;&lt; 1];<br />
inline int lowbit(int x){return x & (-x);}<br />
inline void add(int p,int k){for(register int i = p;i &lt;= cnt;i += lowbit(i))c[i] += k;return;}<br />
inline int query(int p){int res = 0;for(register int i = p;i &gt;= 1;i -= lowbit(i))res += c[i];return res;}<br />
void solve(int l,int r,int L,int R)<br />
{<br />
	if(L == R)<br />
	{<br />
		for(register int i = l;i &lt;= r;++i)if(q[i].id)ans[q[i].id] = L;<br />
		return;<br />
	}<br />
	register int mid = ((L + R) &gt;&gt; 1);<br />
	register int l1 = 0,l2 = 0;<br />
	for(register int i = l;i &lt;= r;++i)<br />
	{<br />
		if(q[i].type)<br />
		{<br />
			if(fr[q[i].y] &lt;= mid)add(q[i].x,q[i].k),q1[++l1] = q[i];<br />
			else q2[++l2] = q[i];<br />
		}<br />
		else<br />
		{<br />
			register int res = query(q[i].y) - query(q[i].x - 1);<br />
			if(q[i].k &lt;= res)q1[++l1] = q[i];<br />
			else q[i].k -= res,q2[++l2] = q[i];<br />
		}<br />
	}<br />
	for(register int i = 1;i &lt;= l1;++i)if(!q1[i].id)add(q1[i].x,-q1[i].k);<br />
	for(register int i = 1;i &lt;= l1;++i)q[l + i - 1] = q1[i];<br />
	for(register int i = 1;i &lt;= l2;++i)q[l + l1 - 1 + i] = q2[i];<br />
	solve(l,l + l1 - 1,L,mid);solve(l + l1,r,mid + 1,R);<br />
	return;<br />
}<br />
int main()<br />
{<br />
	scanf("%d%d",&n,&m);<br />
	for(register int i = 1;i &lt;= n;++i)<br />
	{<br />
		a[i] = read();<br />
		q[++tot].x = i;q[tot].y = a[i];q[tot].type = 1;q[tot].k = 1;<br />
		num[++cur] = a[i];<br />
	}<br />
	register char c;<br />
	register int x,y;<br />
	for(register int i = 1;i &lt;= m;++i)<br />
	{<br />
		c = getc();<br />
		if(c == 'Q')<br />
		{<br />
			++tot;<br />
			q[tot].x = read();q[tot].y = read();q[tot].k = read();<br />
			q[tot].id = i;q[tot].type = 0;<br />
		}<br />
		else<br />
		{<br />
			x = read();y = read();<br />
			q[++tot].type = 1;q[tot].k = -1;q[tot].x = x;q[tot].y = a[x];<br />
			q[++tot].type = 1;q[tot].k = 1;q[tot].x = x;q[tot].y = y;<br />
			a[x] = y;<br />
			num[++cur] = y;<br />
		}<br />
	}<br />
	sort(num + 1,num + 1 + cur);<br />
	for(register int i = 1;i &lt;= cur;++i)<br />
	{<br />
		if(i == 1 || num[i] != num[i - 1])<br />
		{<br />
			to[++cnt] = num[i];<br />
			fr[num[i]] = cnt;<br />
		}<br />
	}<br />
	solve(1,tot,1,cnt);<br />
	for(register int i = 1;i &lt;= m;++i)<br />
	{<br />
		if(ans[i])printf("%d\n",to[ans[i]]);<br />
	}<br />
	return 0;<br />
}<br />
</pre></code>
</div>
        </div>
        <div class="blogfile_showtag">
          <img src="http://pic.yupoo.com/wjh15101051/2380cc18/89ee2c05.png">
          In tag:
<a href="../tags/数据结构-主席树.html">数据结构-主席树</a> <a href="../tags/数据结构-树套树.html">数据结构-树套树</a> <a href="../tags/数据结构-整体二分.html">数据结构-整体二分</a> 
          <!--<a href="../tags/blog.html">blog</a>-->
        </div>
      </div>
    </div>
    <div id="middle_nav">
      <div class="blog_host">
        <div class="nav_avator">
          <img src="http://pic.yupoo.com/wjh15101051/72c1aeab/f51d56e0.jpg" alt="avator">
        </div>
        <div class="nav_ID">
          wjh15101051
        </div>
      </div>
      <div class="nav_list">
        <li class="tags">
          <a href="../tags.html">
            <img src="http://pic.yupoo.com/wjh15101051/2380cc18/89ee2c05.png" class="list_icon" id="tags_image">
            Tags
          </a>
        </li>
        <li class="categories">
          <a href="../categories.html">
            <img src="http://pic.yupoo.com/wjh15101051/2ea96b56/7882c4ab.png" class="list_icon" id="categories_image">
            Categories
          </a>
        </li>
        <li class="timeline">
          <a href="../timeline.html">
            <img src="http://pic.yupoo.com/wjh15101051/30365cc7/c1a3be15.png" class="list_icon" id="timeline_image">
            Timeline
          </a>
        </li>
        <li class="about">
          <a href="../about.html">
            <img src="http://pic.yupoo.com/wjh15101051/24f1cb41/e239086e.png" class="list_icon" id="about_image">
            About
          </a>
        </li>
        <li class="toolbox">
          <a href="../toolbox.html">
            <img src="http://pic.yupoo.com/wjh15101051/dee9f673/d3cf682a.png" class="list_icon" id="toolbox_image">
            Toolbox
          </a>
        </li>
        <li class="friends">
            <div class="friends_text">
              <img src="http://pic.yupoo.com/wjh15101051/d291ebed/29f9c807.png" id="friends_image">
              Friends
            </div>
            <div id="fp_friends_list">
              <div id="SGcolin">
                <a href="http://blog.gyx.me/" target="_blank">SGcolin</a>
              </div>
              <div id="Xingcy">
                <a href="https://www.cnblogs.com/xcysblog/" target="_blank">Xingcy</a>
              </div>
              <div id="ZH_comld">
                <a href="https://www.cnblogs.com/ZH-comld/" target="_blank">ZH_comld</a>
              </div>
            </div>
            <br>
          </div>
        </li>
      </div>
    <div class="music_player">
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.0/dist/APlayer.min.css">
      <script src="https://blog-static.cnblogs.com/files/yjlaugus/APlayer.min.js"></script>
      <div id="aplayer" class="aplayer"  data-id="5313691453" data-server="netease" data-type="playlist" data-fixed="true" data-listfolded="true" data-order="random" data-theme="#F58EA8"></div>
      <script src="https://unpkg.com/meting@1.2/dist/Meting.min.js"></script>
    </div>
    <div class="bottom">
      <div>
        Copyright © 2020
        <a id="copyright_user_a" href="index.html">
          <span id="copyright_user">wjh15101051</span>
        </a>
      </div>
      <div class="bottom_anime">ღゝ◡╹)ノ♡</div>
    </div>
  </div>
</body>
</html>
